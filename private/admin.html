<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - Kemenag Siak</title>

    <link rel="stylesheet" href="/css/admin.css" />

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  </head>
  <body class="admin-body">
    <header class="admin-header">
      <div class="header-top">
        <div class="brand-section">
          <img src="/image/logo.png" alt="Logo" />
          <div class="brand-text">
            <h3>Buku Tamu Digital</h3>
            <p>Kemenag Kab. Siak</p>
          </div>
        </div>

        <a href="#" onclick="logout()" class="btn-logout-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Keluar
        </a>
      </div>

      <div class="header-tabs">
        <a href="#" class="tab-link active">
          <svg
            style="
              width: 14px;
              height: 14px;
              margin-bottom: -2px;
              margin-right: 4px;
            "
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
          Daftar Tamu
        </a>
      </div>
    </header>

    <main class="admin-main">
      <div class="page-heading">
        <div class="heading-text">
          <h1>Daftar Tamu</h1>
          <p>
            Total
            <span id="totalData" style="font-weight: bold; color: #111">0</span>
            tamu terdaftar
          </p>
        </div>

        <button class="btn-export-excel" onclick="downloadExcel()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Export Excel
        </button>
      </div>

      <div class="filter-container">
        <div class="search-wrapper">
          <svg
            class="search-icon-svg"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
          <input
            type="text"
            id="searchInput"
            placeholder="Cari nama, alamat, atau keperluan..."
          />
        </div>

        <select id="filterBulan" class="filter-select">
          <option value="">Semua Bulan</option>
          <option value="1">Januari</option>
          <option value="2">Februari</option>
          <option value="3">Maret</option>
          <option value="4">April</option>
          <option value="5">Mei</option>
          <option value="6">Juni</option>
          <option value="7">Juli</option>
          <option value="8">Agustus</option>
          <option value="9">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>

        <select id="filterTahun" class="filter-select">
          <option value="">Semua Tahun</option>
        </select>

        <div class="filter-btn-wrapper">
          <button
            id="btnFilterTujuan"
            onclick="toggleFilterMenu()"
            style="
              background: white;
              border: 1px solid #e5e7eb;
              padding: 8px 12px;
              border-radius: 6px;
              cursor: pointer;
              color: #6b7280;
              height: 100%;
            "
          >
            <svg
              style="width: 16px"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
              />
            </svg>
          </button>

          <div id="popupTujuan" class="filter-popup">
            <div class="filter-option active" onclick="pilihTujuan('')">
              Semua Tujuan
            </div>
            <div class="filter-option" onclick="pilihTujuan('Kepala Kantor')">
              Kepala Kantor
            </div>
            <div
              class="filter-option"
              onclick="pilihTujuan('Subbag Tata Usaha')"
            >
              Subbag Tata Usaha
            </div>
            <div
              class="filter-option"
              onclick="pilihTujuan('Seksi Pendidikan Islam')"
            >
              Seksi Pendidikan Islam
            </div>
            <div
              class="filter-option"
              onclick="pilihTujuan('Seksi Bimas Islam')"
            >
              Seksi Bimas Islam
            </div>
            <div
              class="filter-option"
              onclick="pilihTujuan('Penyelenggara Syariah')"
            >
              Penyelenggara Syariah
            </div>
            <div
              class="filter-option"
              onclick="pilihTujuan('Penyelenggara Kristen')"
            >
              Penyelenggara Kristen
            </div>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table class="clean-table">
          <thead>
            <tr>
              <th width="5%">NO</th>
              <th width="15%">TANGGAL</th>
              <th width="20%">NAMA</th>
              <th width="10%" style="text-align: center">GENDER</th>
              <th width="20%">ALAMAT</th>
              <th width="15%">TUJUAN</th>
              <th width="20%">KEPERLUAN</th>
              <th width="5%" style="text-align: center">AKSI</th>
            </tr>
          </thead>
          <tbody id="tabelData">
            <tr>
              <td
                colspan="8"
                style="text-align: center; padding: 40px; color: #6b7280"
              >
                Sedang memuat data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      // 1. Cek Login
      if (localStorage.getItem("isAdminLoggedIn") !== "true") {
        window.location.href = "/masuk-admin";
      }

      function logout() {
        localStorage.removeItem("isAdminLoggedIn");
        window.location.href = "/masuk-admin";
      }

      // --- VARIABEL GLOBAL ---
      let allData = [];
      let currentFilterTujuan = ""; // Menyimpan tujuan yang sedang dipilih

      // 2. Load Data
      fetch("/api/tamu")
        .then((res) => res.json())
        .then((data) => {
          allData = data;
          populateYears(allData); // Isi tahun otomatis
          applyFilters(); // Tampilkan data
        })
        .catch((err) => console.error(err));

      // --- RENDER TABEL ---
      function renderTable(data) {
        const tabel = document.getElementById("tabelData");
        document.getElementById("totalData").innerText = data.length;

        if (data.length === 0) {
          tabel.innerHTML =
            '<tr><td colspan="8" style="text-align:center; padding:40px; color:#9ca3af;">Tidak ada data ditemukan.</td></tr>';
          return;
        }

        let html = "";
        data.forEach((tamu, index) => {
          const dateStr = new Date(tamu.waktu_kunjungan).toLocaleDateString(
            "id-ID",
            { day: "2-digit", month: "2-digit", year: "numeric" },
          );

          let genderHtml =
            tamu.jenis_kelamin === "Laki-laki"
              ? '<div class="badge-circle bg-blue-light" title="Laki-laki">L</div>'
              : '<div class="badge-circle bg-pink-light" title="Perempuan">P</div>';

          html += `
                    <tr>
                        <td style="color:#6b7280;">${index + 1}</td>
                        <td style="color:#6b7280;">${dateStr}</td>
                        <td style="font-weight:600; color:#111827;">${tamu.nama}</td>
                        <td align="center">${genderHtml}</td>
                        <td style="color:#4b5563;">${tamu.alamat}</td>
                        <td><span class="badge-pill bg-green-soft">${tamu.tujuan_keperluan}</span></td>
                        <td style="color:#4b5563;">${tamu.uraian_keperluan}</td>
                        <td align="center">
                            <button class="btn-trash" onclick="hapusData(${tamu.id})" title="Hapus">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
        });
        tabel.innerHTML = html;
      }

      // --- LOGIKA FILTER GABUNGAN (SEARCH + BULAN + TAHUN + TUJUAN) ---
      function applyFilters() {
        const keyword = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const selectedBulan = document.getElementById("filterBulan").value;
        const selectedTahun = document.getElementById("filterTahun").value;
        // currentFilterTujuan diambil dari variabel global

        const filtered = allData.filter((item) => {
          const dateObj = new Date(item.waktu_kunjungan);
          const itemBulan = (dateObj.getMonth() + 1).toString();
          const itemTahun = dateObj.getFullYear().toString();

          // 1. Cek Keyword (Nama/Alamat/Keperluan)
          const matchKeyword =
            item.nama.toLowerCase().includes(keyword) ||
            item.alamat.toLowerCase().includes(keyword) ||
            item.uraian_keperluan.toLowerCase().includes(keyword);

          // 2. Cek Bulan & Tahun
          const matchBulan =
            selectedBulan === "" || itemBulan === selectedBulan;
          const matchTahun =
            selectedTahun === "" || itemTahun === selectedTahun;

          // 3. Cek Tujuan (PENTING)
          const matchTujuan =
            currentFilterTujuan === "" ||
            item.tujuan_keperluan === currentFilterTujuan;

          return matchKeyword && matchBulan && matchTahun && matchTujuan;
        });

        renderTable(filtered);
      }

      // --- LOGIKA POPUP MENU FILTER TUJUAN ---
      function toggleFilterMenu() {
        document.getElementById("popupTujuan").classList.toggle("show");
      }

      function pilihTujuan(tujuan) {
        currentFilterTujuan = tujuan; // Set filter global

        // UI: Update tampilan menu aktif
        document.querySelectorAll(".filter-option").forEach((el) => {
          el.classList.remove("active");
          if (el.innerText === (tujuan || "Semua Tujuan")) {
            el.classList.add("active");
          }
        });

        // Ganti warna tombol corong jika filter aktif
        const btn = document.getElementById("btnFilterTujuan");
        if (tujuan !== "") {
          btn.style.borderColor = "#00b050";
          btn.style.color = "#00b050";
        } else {
          btn.style.borderColor = "#e5e7eb";
          btn.style.color = "#6b7280";
        }

        toggleFilterMenu(); // Tutup menu
        applyFilters(); // Terapkan filter
      }

      // Tutup popup jika klik di luar
      window.onclick = function (event) {
        if (!event.target.closest(".filter-btn-wrapper")) {
          document.getElementById("popupTujuan").classList.remove("show");
        }
      };

      // Event Listener Search & Dropdown
      document
        .getElementById("searchInput")
        .addEventListener("keyup", applyFilters);
      document
        .getElementById("filterBulan")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filterTahun")
        .addEventListener("change", applyFilters);

      // --- EXPORT EXCEL ---
      function downloadExcel() {
        // Kita export data yang sedang tampil (sudah difilter)
        // Jalankan ulang logika filter untuk mendapatkan data bersih
        const keyword = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const selectedBulan = document.getElementById("filterBulan").value;
        const selectedTahun = document.getElementById("filterTahun").value;

        const dataToExport = allData.filter((item) => {
          const dateObj = new Date(item.waktu_kunjungan);
          const itemBulan = (dateObj.getMonth() + 1).toString();
          const itemTahun = dateObj.getFullYear().toString();
          const matchKeyword =
            item.nama.toLowerCase().includes(keyword) ||
            item.alamat.toLowerCase().includes(keyword) ||
            item.uraian_keperluan.toLowerCase().includes(keyword);
          const matchBulan =
            selectedBulan === "" || itemBulan === selectedBulan;
          const matchTahun =
            selectedTahun === "" || itemTahun === selectedTahun;
          const matchTujuan =
            currentFilterTujuan === "" ||
            item.tujuan_keperluan === currentFilterTujuan;
          return matchKeyword && matchBulan && matchTahun && matchTujuan;
        });

        if (dataToExport.length === 0) {
          alert("Tidak ada data untuk diexport!");
          return;
        }

        // Format Data untuk Excel
        const formattedData = dataToExport.map((item, index) => ({
          No: index + 1,
          Tanggal: new Date(item.waktu_kunjungan).toLocaleDateString("id-ID"),
          "Nama Lengkap": item.nama,
          Gender: item.jenis_kelamin,
          Alamat: item.alamat,
          "No HP": item.no_hp || "-",
          Tujuan: item.tujuan_keperluan,
          Keperluan: item.uraian_keperluan,
        }));

        const worksheet = XLSX.utils.json_to_sheet(formattedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Tamu");
        XLSX.writeFile(workbook, "Laporan_Buku_Tamu.xlsx");
      }

      // --- ISI TAHUN OTOMATIS ---
      function populateYears(data) {
        const select = document.getElementById("filterTahun");
        const years = [
          ...new Set(
            data.map((item) => new Date(item.waktu_kunjungan).getFullYear()),
          ),
        ];
        years.sort((a, b) => b - a);
        years.forEach((year) => {
          const opt = document.createElement("option");
          opt.value = year;
          opt.text = year;
          select.appendChild(opt);
        });
      }

      // --- HAPUS DATA ---
      function hapusData(id) {
        if (confirm("Yakin ingin menghapus data ini?")) {
          fetch(`/api/tamu/${id}`, { method: "DELETE" })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                // Refresh data
                fetch("/api/tamu")
                  .then((r) => r.json())
                  .then((d) => {
                    allData = d;
                    applyFilters();
                  });
              }
            });
        }
      }
    </script>
  </body>
</html>
